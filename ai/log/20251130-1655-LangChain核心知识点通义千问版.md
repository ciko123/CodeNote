# LangChain 核心知识点 - 通义千问版

> **用途**：用于生成 Jupyter Notebook 教学文档
> 
> **原则**：最少最关键最有效的代码验证知识点
> 
> **版本**：基于 LangChain 1.0+ API + 通义千问
> 
> **API**：统一使用通义千问模型和组件


注意：生成的案例不要使用旧的或过时的API或引用

---

## 一、基础层：LLM + Prompt

### ChatModels（ChatTongyi）
**知识点说明**：ChatTongyi 是与通义千问对话的核心接口，统一调用大模型，通过参数控制输出风格。

**学习要求**：
- 掌握 ChatTongyi 基础调用
- 理解核心参数作用
- 能控制输出风格

**案例要求**：
- 使用 ChatTongyi 运行简单对话
- 设置 temperature = 0.7（推荐值）
- 设置 max_tokens = 500（实用值）
- 使用 model="qwen-plus"（通义千问推荐模型）
- 验证点：能成功获取通义千问 AI 回复并控制输出长度

### 核心参数（model / temperature / max_tokens）
**知识点说明**：这些参数用于控制通义千问 LLM 的行为，如模型选择、随机性、生成长度等。

**学习要求**：
- 理解各参数的作用机制
- 能根据需求调整参数
- 掌握通义千问最佳实践配置

**案例要求**：
- 编写简单 Prompt 测试通义千问代表性参数
- 使用 model="qwen-turbo"（快速响应）
- 设置 temperature = 0.7（平衡随机性和一致性）
- 设置 max_tokens = 300（控制输出长度）
- 验证点：能根据参数调节通义千问模型输出风格

### PromptTemplate
**知识点说明**：PromptTemplate 用于创建可复用的提示词模板，实现参数化填充。

**学习要求**：
- 掌握模板创建语法
- 理解变量填充机制
- 能设计灵活的模板

**案例要求**：
- 编写 PromptTemplate("请用通义千问的视角写一段关于 {topic} 的介绍")
- 输入单个 topic（如 "人工智能"）
- 验证点：模板能动态生成 prompt 并传入通义千问 LLM

### ChatPromptTemplate
**知识点说明**：ChatPromptTemplate 是专为多轮对话设计的提示词模板体系，支持 system/user/assistant 三角色。

**学习要求**：
- 理解多角色对话结构
- 掌握角色消息格式
- 能构建复杂对话模板

**案例要求**：
- 创建 ChatPromptTemplate：
  - system：你是一个精通中文的通义千问助手
  - user：请用通义千问的能力讲解 {concept}
- 输入 concept = "LangChain 框架"
- 验证点：能正确填充变量并按角色生成通义千问聊天消息格式

### MessagesPlaceholder
**知识点说明**：用于在提示词模板中保留"历史消息占位"，适配消息历史组件。

**学习要求**：
- 理解占位符作用
- 掌握动态填充机制
- 能与通义千问消息历史组件集成

**案例要求**：
- 创建带 MessagesPlaceholder("history") 的 ChatPromptTemplate
- 手动提供 2 条通义千问历史消息进行测试
- 验证点：占位符能被通义千问历史消息正确填充

### Structured Output（通义千问推荐方式）
**知识点说明**：通过通义千问 `llm.with_structured_output()` 方法，让 LLM 输出结构化格式，比传统 OutputParser 更简洁。

**学习要求**：
- 掌握通义千问 `with_structured_output()` 方法
- 理解 Pydantic 模型定义
- 能设计输出格式规范

**案例要求**：
- 定义 Pydantic 模型：
  ```python
  from pydantic import BaseModel
  class TongyiOutput(BaseModel):
      title: str
      summary: str
      confidence: float
  ```
- 使用通义千问 `llm.with_structured_output(TongyiOutput)`
- 验证点：通义千问输出满足指定 Pydantic 模型结构

---

## 二、数据层：文档、Embedding、向量库

### Document Loaders（Text）
**知识点说明**：Loaders 用于从数据源加载文档，是通义千问 RAG 的起点。

**学习要求**：
- 掌握基础 Loader 使用
- 理解文档加载机制
- 能处理本地文档

**案例要求**：
- 使用 TextLoader 加载本地中文 txt 文件
- 验证返回的 Document[] 结构
- 验证点：能正常返回中文文档内容和元数据

### Splitters：RecursiveCharacterTextSplitter
**知识点说明**：文本切片器用于将文档按规则切分成 chunk，保证通义千问向量化质量。

**学习要求**：
- 理解文本切分原理
- 掌握切分参数设置
- 能优化切分策略

**案例要求**：
- 使用 chunk_size=500 对中文文档切片
- 观察切片数量和内容长度
- 验证点：中文文档被正确切分成指定大小的片段

### Embedding（通义千问 DashScope）
**知识点说明**：使用通义千问 DashScope Embedding 将文本转换为向量，是向量检索的基础。

**学习要求**：
- 理解通义千问向量化原理
- 掌握 DashScope Embeddings 使用
- 能进行中文文本向量化

**案例要求**：
- 使用 DashScopeEmbeddings 对单句中文话进行向量化
- 检查向量维度和数据类型
- 验证点：能成功生成通义千问数值向量

### Vector Stores（FAISS + 通义千问）
**知识点说明**：向量库用于存储通义千问 Embedding 并进行相似度检索。

**学习要求**：
- 掌握向量库创建和使用
- 理解相似度检索原理
- 能进行向量存储和查询

**案例要求**：
- 创建 FAISS 向量库：
  - 插入 3 条通义千问预设中文文本向量
  - 执行相似度检索
- 验证点：能返回最相似的中文文本片段

### Retriever（k parameter）
**知识点说明**：Retriever 封装了通义千问向量库检索逻辑，通过参数控制检索结果。

**学习要求**：
- 理解检索器配置参数
- 掌握结果数量控制
- 能设置检索参数

**案例要求**：
- 设置 Retriever(k=2) 检索通义千问相关中文文档
- 验证返回结果数量
- 验证点：能正确控制通义千问检索结果数量

---

## 三、编排层：LCEL + Runnable（核心）

### Runnable
**知识点说明**：Runnable 是 LangChain 1.0 的核心抽象，所有通义千问步骤都能用 Runnable 链式拼接。

**学习要求**：
- 理解 Runnable 抽象概念
- 掌握链式拼接方法
- 能构建通义千问处理流程

**案例要求**：
- 实现 prompt → 通义千问 llm 的简单链
- 使用 invoke 方法调用
- 验证点：链条能顺序执行并返回通义千问结果

### RunnableMap
**知识点说明**：并行执行多个 Runnable，并将结果组合成一个字典。

**学习要求**：
- 理解并行执行机制
- 掌握结果组合方法
- 能优化通义千问处理性能

**案例要求**：
- 并行执行通义千问 LLM 调用和字符串处理：
  - 通义千问生成摘要
  - 字符串计算长度
- 验证点：输出结果包含两个字段

### RunnablePassthrough
**知识点说明**：用于在链中保留原始输入，做多路分发时非常常用。

**学习要求**：
- 理解数据传递机制
- 掌握输入保留方法
- 能设计通义千问数据流路径

**案例要求**：
- 构建包含 Passthrough 的链：
  - 输入 → 复制 → 通义千问 LLM 处理 → 合并结果
- 验证点：原始输入值在输出中完整保留

### prompt | llm | parser（通义千问最重要写法）
**知识点说明**：LangChain 1.0 通过 "|" 操作符创建通义千问 LCEL 流水线，是推荐写法。

**学习要求**：
- 掌握管道操作符语法
- 理解数据流向
- 能构建完整通义千问处理链

**案例要求**：
- 构建完整链：
  - PromptTemplate | 通义千问 LLM | StrOutputParser
- 验证点：链式调用返回通义千问字符串格式结果

### OutputParser（传统方式，兼容性）
**知识点说明**：用于严格解析通义千问模型输出，使其强制符合结构化格式（兼容性用法）。

**学习要求**：
- 掌握解析器使用方法
- 理解格式验证机制
- 能处理解析错误

**案例要求**：
- 使用 JsonOutputParser 解析通义千问 LLM 输出
- 验证解析结果为字典格式
- 验证点：能正确解析通义千问 JSON 格式输出

### Streaming（通义千问流式输出）
**知识点说明**：支持通义千问流式输出，可实时查看生成过程。

**学习要求**：
- 理解流式输出原理
- 掌握流式调用方法
- 能实现通义千问基础流式功能

**案例要求**：
- 使用通义千问 stream 方法获取流式输出
- 验证返回迭代器对象
- 验证点：能逐个 token 获取通义千问输出内容

---

## 四、消息历史管理（通义千问 + LangChain 1.0+）

### ChatMessageHistory 基础
**知识点说明**：ChatMessageHistory 是 LangChain 1.0+ 的消息历史管理基础类，替代传统 Memory。

**学习要求**：
- 理解通义千问消息历史管理机制
- 掌握 ChatMessageHistory 使用
- 能实现基础通义千问对话记录

**案例要求**：
- 创建 ChatMessageHistory 实例
- 添加 2 条通义千问用户和助手消息
- 验证消息格式和内容
- 验证点：能正确保存和检索通义千问对话历史

### RunnableWithMessageHistory
**知识点说明**：将通义千问 LCEL 链包装为支持消息历史的链，是 LangChain 1.0+ 的推荐方式。

**学习要求**：
- 理解包装器工作原理
- 掌握配置方法
- 能实现带历史的通义千问对话链

**案例要求**：
- 创建通义千问基础 LCEL 链（prompt | llm）
- 使用 RunnableWithMessageHistory 包装
- 配置 session_id 和 history_factory
- 验证点：多轮通义千问对话能保持历史上下文

### 消息历史配置模式
**知识点说明**：通过配置实现通义千问消息历史的动态管理。

**学习要求**：
- 理解配置注入机制
- 掌握历史工厂模式
- 能实现通义千问会话隔离

**案例要求**：
- 创建基于 session_id 的通义千问历史工厂
- 配置 RunnableWithMessageHistory
- 验证不同通义千问会话的历史隔离
- 验证点：不同 session_id 的通义千问历史互不干扰

---

## 五、RAG（通义千问核心能力）

### RAG Pipeline（基础）
**知识点说明**：RAG 是通义千问最核心能力，用检索增强生成。

**学习要求**：
- 理解通义千问 RAG 完整流程
- 掌握各组件集成
- 能构建端到端系统

**案例要求**：
- 实现最小通义千问 RAG 管线：
  - 中文文档加载 → 切片 → 通义千问向量化 → 检索 → 生成
- 验证点：通义千问回答基于检索到的中文文档内容

### 简单检索增强
**知识点说明**：基础通义千问检索增强生成，验证 RAG 核心概念。

**学习要求**：
- 掌握通义千问检索流程
- 理解上下文构建
- 能实现基础中文问答

**案例要求**：
- 基于 3 条通义千问中文文档构建问答系统
- 验证检索结果和生成答案
- 验证点：通义千问答案包含中文文档中的关键信息

---

## 六、行动层：Tools + Agents（通义千问）

### @tool 装饰器
**知识点说明**：通过 Python 函数注册成通义千问 Agent 工具。

**学习要求**：
- 掌握工具注册方法
- 理解工具调用机制
- 能设计通义千问自定义工具

**案例要求**：
- 创建一个简单的中文 calculator 工具
- 验证工具注册和调用
- 验证点：工具能正确执行并返回通义千问结果

### Agent 创建（通义千问 + LangChain 1.0+ 完整流程）
**知识点说明**：使用 `create_react_agent` 创建通义千问 Agent，配合 `AgentExecutor` 执行。

**学习要求**：
- 理解通义千问 Agent 工作原理
- 掌握完整创建流程
- 能实现工具调用

**案例要求**：
- 使用 create_react_agent(通义千问 llm, tools, prompt) 创建 Agent
- 配置 AgentExecutor(agent=agent, tools=tools)
- 验证通义千问 Agent 能调用工具解决问题
- 验证点：通义千问 Agent 能自动选择并使用工具

### AgentExecutor 基础
**知识点说明**：用于执行通义千问 Agent 的主循环，管理工具调用。

**学习要求**：
- 理解执行器作用
- 掌握基础执行流程
- 能管理通义千问工具调用

**案例要求**：
- 使用 AgentExecutor 运行通义千问简单 Agent
- 验证执行过程和结果
- 验证点：AgentExecutor 能正确管理通义千问工具调用流程

---

## 七、LangGraph（高级模块）

> **注意**：LangGraph 属于高级内容，建议独立学习

### 状态（State）基础
**知识点说明**：状态用于在通义千问图执行过程中存储信息。

**学习要求**：
- 理解状态管理机制
- 掌握基础状态定义
- 能设计通义千问简单状态结构

**案例要求**：
- 定义包含 query 和 result 的通义千问简单 State
- 验证状态读写操作
- 验证点：状态能在通义千问节点间正确传递

### 节点（Node）基础
**知识点说明**：每个 Node 执行一个通义千问处理步骤。

**学习要求**：
- 理解节点执行逻辑
- 掌握节点定义方法
- 能设计通义千问处理步骤

**案例要求**：
- 创建两个通义千问简单节点：
  - 处理输入节点
  - 生成输出节点
- 验证点：节点能按顺序执行

---

## 八、应用工程能力（通义千问）

### FastAPI 基础部署
**知识点说明**：通过 FastAPI 将通义千问 LCEL 流水线发布为 API 服务。

**学习要求**：
- 掌握 FastAPI 基础
- 理解 API 设计
- 能部署通义千问简单服务

**案例要求**：
- 用 FastAPI 包装一个通义千问 LLM Chain
- 创建简单的 POST 端点
- 验证点：能通过 HTTP 调用并获取通义千问回复

### LCEL 配置管理
**知识点说明**：LangChain 1.0+ 的通义千问动态配置和热切换能力。

**学习要求**：
- 理解配置模式
- 掌握动态切换方法
- 能实现通义千问灵活配置

**案例要求**：
- 使用 chain.configurable_alternatives() 配置多个通义千问模型
  - qwen-turbo（快速）
  - qwen-plus（平衡）
- 演示运行时通义千问配置切换
- 验证点：能动态切换不同的通义千问模型配置

### 基础错误处理
**知识点说明**：为通义千问 LangChain 应用添加基础的错误处理机制。

**学习要求**：
- 理解常见错误类型
- 掌握基础异常处理
- 能设计健壮的通义千问应用

**案例要求**：
- 为通义千问 LLM 调用添加 try-catch 处理
- 验证错误捕获和返回
- 验证点：异常情况下通义千问应用不会崩溃

### 简单性能优化
**知识点说明**：通义千问基础的性能优化技巧。

**学习要求**：
- 理解性能瓶颈
- 掌握基础优化方法
- 能提升通义千问响应速度

**案例要求**：
- 实现通义千问简单响应缓存
- 验证缓存命中效果
- 验证点：重复通义千问请求能从缓存获取结果

---

## 📊 学习优先级说明

### 🟢 **核心优先级**（必须掌握）
- 通义千问 ChatTongyi 基础调用
- Prompt 模板系统
- LCEL 链式语法
- RunnableWithMessageHistory 通义千问消息历史
- 基础 RAG 流程
- 简单工具和 Agent

### 🟡 **重要优先级**（建议掌握）
- 通义千问文档处理和向量检索
- `with_structured_output` 通义千问结构化输出
- LCEL 配置管理
- 基础部署和错误处理

### 🔴 **高级优先级**（可选学习）
- LangGraph 图控制
- 高级 RAG 策略
- 复杂 Agent 协作

---

## 🎯 通义千问 + LangChain 1.0+ 验证原则

### **通义千问现代化 API**
- 优先使用通义千问 `with_structured_output()` 替代传统 OutputParser
- 使用 `RunnableWithMessageHistory` 替代传统 Memory
- 采用 LCEL 管道语法构建通义千问处理链

### **代码最小化**
- 每个案例不超过 20 行核心代码
- 避免多次通义千问 API 调用对比
- 使用预设中文数据减少准备时间

### **验证有效性**
- 每个验证点都有明确成功标准
- 避免需要长时间运行的测试
- 提供通义千问即时反馈机制

### **实用性导向**
- 专注 80% 中文常用使用场景
- 提供通义千问最佳实践配置
- 包含基础错误处理

---

## 📝 使用说明

### **生成 Notebook 时**
1. **按优先级顺序**：先核心后高级
2. **独立验证**：每个通义千问知识点独立可运行
3. **现代化 API**：使用 LangChain 1.0+ + 通义千问推荐方式
4. **完整示例**：提供从导入到验证的完整代码
5. **错误处理**：包含基础的异常处理示例

### **学习路径建议**
1. **Week 1**：掌握通义千问核心优先级内容（重点 LCEL 和消息历史）
2. **Week 2**：学习重要优先级内容（结构化输出和配置管理）
3. **Week 3+**：探索高级优先级内容（LangGraph 和复杂应用）

---

## 🔧 通义千问环境配置

### **必需的环境变量**
```bash
# 通义千问 API 配置
TONGYI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
TONGYI_API_KEY=your_api_key_here
```

### **推荐的模型配置**
```python
# 快速响应模型
model="qwen-turbo"

# 平衡性能模型
model="qwen-plus"

# 高性能模型
model="qwen-max"
```

---

## 🔄 通义千问版本优势

### **中文优化**
- 更好的中文理解和生成能力
- 适合中文 RAG 和对话场景
- 成本效益更高

### **稳定性**
- 国内网络访问更稳定
- API 响应速度更快
- 服务可靠性更高

---

**🎯 目标**：基于通义千问 + LangChain 1.0+ API，用最少的代码，最关键的知识点，最有效的验证方式，帮助学习者快速掌握现代化中文 LangChain 核心技能。
